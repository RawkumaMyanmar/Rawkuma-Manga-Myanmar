<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Reader | Rawkuma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --nav-bg: rgba(15, 23, 42, 0.95); --accent: #8b5cf6; }
        body { 
            font-family: sans-serif; margin: 0; background: var(--bg); color: white; 
            user-select: none; -webkit-user-select: none; 
            overflow-x: hidden;
        }
        nav { 
            background: var(--nav-bg); padding: 10px 15px; position: fixed; top: 0; width: 100%; 
            z-index: 1000; display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);
            box-sizing: border-box;
        }
        nav a { color: white; text-decoration: none; font-size: 18px; }
        .ch-info { flex: 1; display: flex; flex-direction: column; align-items: center; }
        
        #chapter-select {
            background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--accent);
            border-radius: 5px; padding: 2px 8px; font-size: 12px; outline: none; margin-top: 4px;
        }
        #chapter-select option { background: var(--bg); color: white; }

        .viewer { margin-top: 60px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; width: 100%; position: relative; }
        
        /* Image Security */
        .viewer img { 
            width: 100%; max-width: 800px; display: block; height: auto; 
            pointer-events: none;
            -webkit-touch-callout: none;
            border-bottom: 1px solid #1e293b;
        }
        
        /* Watermark Overlay Styling */
        #protection-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 999; pointer-events: none; overflow: hidden;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            opacity: 0.12; /* Watermark အမှိန်နှုန်း */
        }
        .wm-text { transform: rotate(-45deg); font-size: 14px; margin: 60px; white-space: nowrap; color: white; font-weight: bold; }

        .status-msg { padding: 80px 20px; text-align: center; }
        .btn-action { display: inline-block; background: var(--accent); color: white; padding: 10px 20px; border-radius: 12px; text-decoration: none; font-weight: bold; margin-top: 15px; }

        .controls { padding: 30px; display: flex; justify-content: center; gap: 15px; background: var(--bg); margin-bottom: 30px; }
        .btn-nav { background: var(--accent); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 13px; }
        .btn-nav.disabled { background: #334155; pointer-events: none; opacity: 0.5; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="protection-layer"></div>

    <nav>
        <a href="javascript:history.back()"><i class="fas fa-arrow-left"></i></a>
        <div class="ch-info">
            <div id="manga-title" style="font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">Manga Name</div>
            <select id="chapter-select"></select>
        </div>
        <a href="index.html"><i class="fas fa-home"></i></a>
    </nav>

    <div class="viewer" id="image-container">
        <div id="loader" style="padding:100px; text-align:center;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p style="margin-top:10px; color:#64748b;">Securing Content...</p>
        </div>
    </div>

    <div class="controls" id="footer-nav" style="display:none;">
        <a href="#" id="prev-btn" class="btn-nav">PREV</a>
        <a href="#" id="next-btn" class="btn-nav">NEXT</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Security Level 1: Domain Lockdown ပြင်ဆင်ချက် ---
        const allowedHosts = [
            "rawkumamyanmar.github.io", // သင်အခုသုံးနေတဲ့ Domain
            "rawkuma-8f1ba.web.app", 
            "rawkuma-8f1ba.firebaseapp.com", 
            "localhost"
        ];

        if (!allowedHosts.includes(window.location.hostname)) {
            document.body.innerHTML = "<div style='padding:50px; text-align:center;'><h3>Security Protection</h3><p>Local viewing is not allowed. Please use the official website.</p></div>";
            throw new Error("Domain not authorized"); // ကျန်တဲ့ code တွေ ဆက်အလုပ်မလုပ်အောင် တားလိုက်တာပါ
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDkC9yCwozUjgTfFZ140qG112cU8GDCh44",
            authDomain: "rawkuma-8f1ba.firebaseapp.com",
            projectId: "rawkuma-8f1ba",
            storageBucket: "rawkuma-8f1ba.firebasestorage.app",
            messagingSenderId: "8257070386",
            appId: "1:8257070386:web:74d861728b8378d86f232b"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const chapterImages = {
            "gomibako": {
                "Chapter 01": ["https://i.ibb.co/LDFt7Mwv/1.jpg"],
                "Chapter 02": ["https://i.ibb.co/cSyPR5KF/IMG-20260106-000718-017.jpg"],
                "Chapter 03": ["https://i.ibb.co/pBXnbVJP/Please-Bully-Me-Cover.webp"]
            }
        };

        const chapterMeta = {
            "gomibako": { "Chapter 04": { type: "paid" } }
        };

        const params = new URLSearchParams(window.location.search);
        const mangaId = params.get('id');
        let currentCh = params.get('ch');

        // Dynamic Watermark: User Email ကို ပုံအပေါ်မှာ ဖြန့်ခင်းခြင်း
        function applyWatermark(email) {
            const layer = document.getElementById('protection-layer');
            layer.innerHTML = "";
            for (let i = 0; i < 50; i++) {
                const el = document.createElement('div');
                el.className = 'wm-text';
                el.innerText = email;
                layer.appendChild(el);
            }
        }

        function setupDropdown() {
            const select = document.getElementById('chapter-select');
            const chapters = Object.keys(chapterImages[mangaId] || {}).sort();
            
            chapters.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch;
                opt.innerText = ch;
                if(ch === currentCh) opt.selected = true;
                select.appendChild(opt);
            });

            select.onchange = (e) => {
                window.location.href = `reader.html?id=${mangaId}&ch=${e.target.value}`;
            };

            const currentIndex = chapters.indexOf(currentCh);
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            if (currentIndex > 0) {
                prevBtn.onclick = () => window.location.href = `reader.html?id=${mangaId}&ch=${chapters[currentIndex-1]}`;
            } else {
                prevBtn.classList.add('disabled');
            }

            if (currentIndex < chapters.length - 1) {
                nextBtn.onclick = () => window.location.href = `reader.html?id=${mangaId}&ch=${chapters[currentIndex+1]}`;
            } else {
                nextBtn.innerText = "END";
                nextBtn.classList.add('disabled');
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (!mangaId || !currentCh) {
                showError("Error", "Missing Data", "index.html", "Go Home");
                return;
            }

            document.getElementById('manga-title').innerText = mangaId.toUpperCase();
            setupDropdown();

            // Watermark ကို Login ဝင်ထားတဲ့ Email နဲ့ပြမယ် (Login မဝင်ရင် Guest လို့ပြမယ်)
            applyWatermark(user ? user.email : "GUEST-USER");

            const isPaid = chapterMeta[mangaId] && chapterMeta[mangaId][currentCh] && chapterMeta[mangaId][currentCh].type === "paid";
            
            if (!isPaid) {
                renderImages();
            } else {
                if (!user) {
                    showError("Login Required", "ဤအပိုင်းကိုဖတ်ရန် Login ဝင်ပေးပါ။", "details.html?id="+mangaId, "Back");
                } else {
                    const purchaseDoc = await db.collection("users").doc(user.uid).collection("purchased_chapters").doc(`${mangaId}_${currentCh}`).get();
                    if (purchaseDoc.exists) renderImages();
                    else showError("Access Denied", "ဤအပိုင်းကို မဝယ်ယူရသေးပါ။", "details.html?id="+mangaId, "Buy Now");
                }
            }
        });

        function renderImages() {
            const container = document.getElementById('image-container');
            container.innerHTML = ""; 
            if (chapterImages[mangaId] && chapterImages[mangaId][currentCh]) {
                chapterImages[mangaId][currentCh].forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.ondragstart = () => false; // Drag ဆွဲတာ တားမြစ်ခြင်း
                    container.appendChild(img);
                });
                document.getElementById('footer-nav').style.display = 'flex';
            } else {
                showError("Coming Soon", "ပုံများ မတင်ရသေးပါဗျာ။", "details.html?id="+mangaId, "Go Back");
            }
        }

        function showError(t, m, l, b) {
            document.getElementById('image-container').innerHTML = `<div class="status-msg"><h3>${t}</h3><p style='color:#94a3b8'>${m}</p><a href="${l}" class="btn-action">${b}</a></div>`;
        }

        // --- Security Level 3: Keyboard Shortcuts Protection ---
        document.onkeydown = function(e) {
            if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && e.keyCode == 85)) {
                return false;
            }
        };
    </script>
</body>
</html>
