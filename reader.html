<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Secure Reader | Rawkuma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #030712; --accent: #8b5cf6; --glass: rgba(255, 255, 255, 0.03); }
        
        /* Protection Layers */
        * { 
            -webkit-user-select: none; -ms-user-select: none; user-select: none; 
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: white; overflow-x: hidden; }

        /* Floating Watermark Style */
        .watermark {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden;
            display: grid; grid-template-columns: repeat(3, 1fr);
            opacity: 0.15; /* ဝါးဝါးလေးပဲ မြင်ရအောင် */
            font-size: 14px; font-weight: bold; transform: rotate(-30deg);
        }
        .watermark span { padding: 40px; display: block; white-space: nowrap; color: #94a3b8; }

        /* Reader Header */
        .reader-nav {
            position: fixed; top: 0; width: 100%; background: rgba(3, 7, 18, 0.95);
            backdrop-filter: blur(15px); z-index: 1000; padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--glass); box-sizing: border-box;
            transition: 0.3s;
        }
        .reader-nav.hide { transform: translateY(-100%); }

        .back-btn { color: white; text-decoration: none; font-size: 18px; width: 30px; }
        
        .manga-container { display: flex; flex-direction: column; align-items: center; margin-top: 55px; min-height: 100vh; position: relative; }
        .manga-image { width: 100%; max-width: 800px; display: block; pointer-events: none; user-select: none; }

        /* Navigation Buttons */
        .bottom-nav {
            padding: 30px 15px 60px; display: flex; justify-content: space-between;
            max-width: 800px; margin: 0 auto; gap: 10px; z-index: 1001; position: relative;
        }
        .nav-btn {
            flex: 1; background: var(--glass); border: 1px solid var(--glass);
            color: white; padding: 12px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 600; transition: 0.2s; text-decoration: none;
        }
        .nav-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(139, 92, 246, 0.1); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Lock UI */
        #lock-screen {
            position: fixed; inset: 0; background: rgba(3, 7, 18, 0.98); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .unlock-card { background: #111827; padding: 30px; border-radius: 20px; border: 1px solid var(--accent); max-width: 300px; }
        .unlock-btn { background: var(--accent); color: white; border: none; padding: 12px 40px; border-radius: 10px; font-weight: bold; margin-top: 20px; cursor: pointer; width: 100%; }

        .loading-spinner { padding: 100px; text-align: center; color: var(--accent); }
    </style>
</head>
<body oncontextmenu="return false;" onkeydown="return disableInspector(event);">

    <div class="watermark" id="watermark-grid"></div>

    <nav class="reader-nav" id="reader-nav">
        <a href="#" id="nav-back-link" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <select id="chapter-selector" onchange="changeChapter(this.value)" style="background:#1e293b; color:white; border:1px solid var(--accent); border-radius:5px; padding:3px 8px;"></select>
        <div style="width: 30px;"></div>
    </nav>

    <div id="lock-screen">
        <div class="unlock-card">
            <i class="fas fa-lock" style="font-size: 40px; color: #fbbf24; margin-bottom: 15px;"></i>
            <h3 id="lock-title">Paid Chapter</h3>
            <p id="lock-price" style="font-size: 14px; color: #94a3b8;"></p>
            <button class="unlock-btn" id="buy-btn">ဝယ်ယူမည်</button>
        </div>
    </div>

    <div class="manga-container" id="image-list">
        <div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
    </div>

    <div class="bottom-nav">
        <button id="prev-btn" class="nav-btn" onclick="prevChapter()"><i class="fas fa-chevron-left"></i> Prev</button>
        <button id="next-btn" class="nav-btn" onclick="nextChapter()">Next <i class="fas fa-chevron-right"></i></button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDkC9yCwozUjgTfFZ140qG112cU8GDCh44",
            authDomain: "rawkuma-8f1ba.firebaseapp.com",
            projectId: "rawkuma-8f1ba",
            storageBucket: "rawkuma-8f1ba.firebasestorage.app",
            messagingSenderId: "8257070386",
            appId: "1:8257070386:web:74d861728b8378d86f232b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        const mangaId = urlParams.get('mangaId');
        let chapterId = urlParams.get('chapterId');
        let allChapters = [];

        document.getElementById('nav-back-link').href = `details.html?id=${mangaId}`;

        // ၁။ Watermark System
        function createWatermark(email) {
            const grid = document.getElementById('watermark-grid');
            grid.innerHTML = "";
            const masked = email ? email : "Unauthorized View";
            for (let i = 0; i < 20; i++) { // Screen တစ်ခုလုံး ပြည့်အောင် ၂၀ ခု ပြမယ်
                const span = document.createElement('span');
                span.innerText = masked;
                grid.appendChild(span);
            }
        }

        // ၂။ Security: Disable DevTools Shortcuts
        function disableInspector(e) {
            if (e.ctrlKey && (e.shiftKey && e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 85) || e.keyCode === 123) {
                return false;
            }
        }

        // ၃။ Data Loading
        async function setupChapters() {
            const snap = await db.collection("mangas").doc(mangaId).collection("chapters").orderBy("order", "asc").get();
            allChapters = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const select = document.getElementById('chapter-selector');
            select.innerHTML = allChapters.map(ch => 
                `<option value="${ch.id}" ${ch.id === chapterId ? 'selected' : ''}>${ch.name}</option>`
            ).join('');
            updateNavButtons();
        }

        function updateNavButtons() {
            const idx = allChapters.findIndex(ch => ch.id === chapterId);
            document.getElementById('prev-btn').disabled = (idx <= 0);
            document.getElementById('next-btn').disabled = (idx >= allChapters.length - 1 || idx === -1);
        }

        async function loadImages() {
            const container = document.getElementById('image-list');
            const lockScreen = document.getElementById('lock-screen');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            lockScreen.style.display = 'none';

            try {
                const chDoc = await db.collection("mangas").doc(mangaId).collection("chapters").doc(chapterId).get();
                const chapter = chDoc.data();
                const price = chapter.price || 0;
                const user = auth.currentUser;

                if (price > 0) {
                    if (!user) return showLock("Access Denied", "Please login to view paid content.", false);
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    if (!(userDoc.data()?.purchasedChapters || []).includes(chapterId)) {
                        return showLock(`Paid Chapter`, `Price: ${price} Coins`, true, price, userDoc.data()?.coins || 0);
                    }
                }

                container.innerHTML = "";
                (chapter.images || []).forEach(url => {
                    const img = new Image();
                    img.src = url;
                    img.className = 'manga-image';
                    container.appendChild(img);
                });
                window.scrollTo(0,0);
            } catch (err) { container.innerHTML = "Error loading content."; }
        }

        function showLock(title, desc, showBtn, price, balance) {
            document.getElementById('lock-screen').style.display = 'flex';
            document.getElementById('lock-title').innerText = title;
            document.getElementById('lock-price').innerText = desc;
            const btn = document.getElementById('buy-btn');
            btn.style.display = showBtn ? 'block' : 'none';
            btn.onclick = () => handlePurchase(price, balance);
        }

        async function handlePurchase(price, balance) {
            if (balance < price) return alert("Not enough coins!");
            const user = auth.currentUser;
            await db.collection("users").doc(user.uid).update({
                coins: firebase.firestore.FieldValue.increment(-price),
                purchasedChapters: firebase.firestore.FieldValue.arrayUnion(chapterId)
            });
            loadImages();
        }

        function prevChapter() { const idx = allChapters.findIndex(ch => ch.id === chapterId); if (idx > 0) changeChapter(allChapters[idx - 1].id); }
        function nextChapter() { const idx = allChapters.findIndex(ch => ch.id === chapterId); if (idx < allChapters.length - 1) changeChapter(allChapters[idx + 1].id); }

        function changeChapter(id) {
            chapterId = id;
            window.history.pushState({}, '', `?mangaId=${mangaId}&chapterId=${id}`);
            document.getElementById('chapter-selector').value = id;
            loadImages();
            updateNavButtons();
        }

        auth.onAuthStateChanged(user => {
            if (user) createWatermark(user.email);
            setupChapters();
            loadImages();
        });
    </script>
</body>
</html>
