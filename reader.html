<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Secure Reader | Rawkuma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #030712; --accent: #8b5cf6; --glass: rgba(255, 255, 255, 0.03); }
        
        /* Protection Layers */
        * { 
            -webkit-user-select: none; -ms-user-select: none; user-select: none; 
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: white; overflow-x: hidden; }

        /* Floating Watermark Style */
        .watermark {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden;
            display: grid; grid-template-columns: repeat(3, 1fr);
            opacity: 0.12;
            font-size: 14px; font-weight: bold; transform: rotate(-30deg);
        }
        .watermark span { padding: 40px; display: block; white-space: nowrap; color: #94a3b8; }

        /* Reader Header - Premium Style */
        .reader-nav {
            position: fixed; top: 0; width: 100%; background: rgba(3, 7, 18, 0.85);
            backdrop-filter: blur(15px); z-index: 1000; padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--glass); box-sizing: border-box;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .reader-nav.hide { transform: translateY(-100%); }

        .back-btn { color: white; text-decoration: none; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; }
        .back-btn:active { background: var(--glass); transform: scale(0.9); }
        
        #chapter-selector { background:#1e293b; color:white; border:1px solid var(--accent); border-radius:10px; padding:6px 12px; outline: none; font-weight: 600; font-size: 13px; }

        .manga-container { display: flex; flex-direction: column; align-items: center; margin-top: 55px; min-height: 100vh; position: relative; }
        .manga-image { width: 100%; max-width: 850px; display: block; pointer-events: none; user-select: none; animation: fadeIn 0.6s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navigation Buttons */
        .bottom-nav {
            padding: 40px 15px 80px; display: flex; justify-content: space-between;
            max-width: 800px; margin: 0 auto; gap: 15px; z-index: 1001; position: relative;
        }
        .nav-btn {
            flex: 1; background: var(--glass); border: 1px solid var(--glass);
            color: white; padding: 14px; border-radius: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 700; transition: 0.3s; text-decoration: none;
        }
        .nav-btn:active { transform: scale(0.95); background: rgba(139, 92, 246, 0.1); border-color: var(--accent); }
        .nav-btn:disabled { opacity: 0.2; filter: grayscale(1); }

        /* Lock UI Premium Animation */
        #lock-screen {
            position: fixed; inset: 0; background: rgba(3, 7, 18, 0.98); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            backdrop-filter: blur(10px);
        }
        .unlock-card { 
            background: #111827; padding: 40px 30px; border-radius: 25px; 
            border: 1px solid var(--glass); max-width: 320px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .unlock-btn { 
            background: linear-gradient(135deg, var(--accent), #7c3aed); 
            color: white; border: none; padding: 15px; border-radius: 12px; 
            font-weight: 800; margin-top: 25px; cursor: pointer; width: 100%; 
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
            transition: 0.3s;
        }
        .unlock-btn:active { transform: scale(0.95); }

        .loading-spinner { padding: 150px; text-align: center; color: var(--accent); }
    </style>
</head>
<body oncontextmenu="return false;" onkeydown="return disableInspector(event);">

    <div class="watermark" id="watermark-grid"></div>

    <nav class="reader-nav" id="reader-nav">
        <a href="#" id="nav-back-link" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <select id="chapter-selector" onchange="changeChapter(this.value)"></select>
        <div style="width: 40px;"></div>
    </nav>

    <div id="lock-screen">
        <div class="unlock-card">
            <div style="width: 70px; height: 70px; background: rgba(251, 191, 36, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-lock" style="font-size: 30px; color: #fbbf24;"></i>
            </div>
            <h3 id="lock-title" style="margin: 0; font-size: 20px;">Paid Chapter</h3>
            <p id="lock-price" style="font-size: 14px; color: #94a3b8; margin: 10px 0 0;"></p>
            <button class="unlock-btn" id="buy-btn">ဝယ်ယူမည်</button>
            <p style="font-size: 10px; color: #4b5563; margin-top: 15px;">VIP members can read for free</p>
        </div>
    </div>

    <div class="manga-container" id="image-list">
        <div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-3x"></i></div>
    </div>

    <div class="bottom-nav">
        <button id="prev-btn" class="nav-btn" onclick="prevChapter()"><i class="fas fa-chevron-left"></i> Prev</button>
        <button id="next-btn" class="nav-btn" onclick="nextChapter()">Next <i class="fas fa-chevron-right"></i></button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDkC9yCwozUjgTfFZ140qG112cU8GDCh44",
            authDomain: "rawkuma-8f1ba.firebaseapp.com",
            projectId: "rawkuma-8f1ba",
            storageBucket: "rawkuma-8f1ba.firebasestorage.app",
            messagingSenderId: "8257070386",
            appId: "1:8257070386:web:74d861728b8378d86f232b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        const mangaId = urlParams.get('mangaId');
        let chapterId = urlParams.get('chapterId');
        let allChapters = [];

        document.getElementById('nav-back-link').href = `details.html?id=${mangaId}`;

        function createWatermark(email) {
            const grid = document.getElementById('watermark-grid');
            grid.innerHTML = "";
            const masked = email ? email : "Unauthorized View";
            for (let i = 0; i < 24; i++) {
                const span = document.createElement('span');
                span.innerText = masked;
                grid.appendChild(span);
            }
        }

        function disableInspector(e) {
            if (e.ctrlKey && (e.shiftKey && e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 85) || e.keyCode === 123) {
                return false;
            }
        }

        async function setupChapters() {
            const snap = await db.collection("mangas").doc(mangaId).collection("chapters").orderBy("order", "asc").get();
            allChapters = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const select = document.getElementById('chapter-selector');
            select.innerHTML = allChapters.map(ch => 
                `<option value="${ch.id}" ${ch.id === chapterId ? 'selected' : ''}>${ch.name}</option>`
            ).join('');
            updateNavButtons();
        }

        function updateNavButtons() {
            const idx = allChapters.findIndex(ch => ch.id === chapterId);
            document.getElementById('prev-btn').disabled = (idx <= 0);
            document.getElementById('next-btn').disabled = (idx >= allChapters.length - 1 || idx === -1);
        }

        async function loadImages() {
            const container = document.getElementById('image-list');
            const lockScreen = document.getElementById('lock-screen');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            lockScreen.style.display = 'none';

            try {
                const chDoc = await db.collection("mangas").doc(mangaId).collection("chapters").doc(chapterId).get();
                const chapter = chDoc.data();
                const price = chapter.price || 0;
                const user = auth.currentUser;

                if (price > 0) {
                    if (!user) return showLock("Access Denied", "Please login to view paid content.", false);
                    
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    const userData = userDoc.data();
                    
                    // --- VIP Check Logic (New) ---
                    const isVIP = userData?.membership === "VIP";
                    const isPurchased = (userData?.purchasedChapters || []).includes(chapterId);

                    if (!isVIP && !isPurchased) {
                        return showLock(`Paid Chapter`, `Price: ${price} Coins`, true, price, userData?.coins || 0);
                    }
                }

                container.innerHTML = "";
                (chapter.images || []).forEach(url => {
                    const img = new Image();
                    img.src = url;
                    img.className = 'manga-image';
                    container.appendChild(img);
                });
                window.scrollTo(0,0);
            } catch (err) { container.innerHTML = "Error loading content."; }
        }

        function showLock(title, desc, showBtn, price, balance) {
            document.getElementById('lock-screen').style.display = 'flex';
            document.getElementById('lock-title').innerText = title;
            document.getElementById('lock-price').innerText = desc;
            const btn = document.getElementById('buy-btn');
            btn.style.display = showBtn ? 'block' : 'none';
            btn.onclick = () => handlePurchase(price, balance);
        }

        async function handlePurchase(price, balance) {
            if (balance < price) return alert("Not enough coins!");
            const user = auth.currentUser;
            const btn = document.getElementById('buy-btn');
            btn.disabled = true;
            btn.innerText = "Processing...";
            
            try {
                await db.collection("users").doc(user.uid).update({
                    coins: firebase.firestore.FieldValue.increment(-price),
                    purchasedChapters: firebase.firestore.FieldValue.arrayUnion(chapterId)
                });
                loadImages();
            } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "ဝယ်ယူမည်"; }
        }

        function prevChapter() { const idx = allChapters.findIndex(ch => ch.id === chapterId); if (idx > 0) changeChapter(allChapters[idx - 1].id); }
        function nextChapter() { const idx = allChapters.findIndex(ch => ch.id === chapterId); if (idx < allChapters.length - 1) changeChapter(allChapters[idx + 1].id); }

        function changeChapter(id) {
            chapterId = id;
            window.history.pushState({}, '', `?mangaId=${mangaId}&chapterId=${id}`);
            document.getElementById('chapter-selector').value = id;
            loadImages();
            updateNavButtons();
        }

        // Header Auto Hide on Scroll
        let lastScroll = 0;
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            const nav = document.getElementById('reader-nav');
            if (currentScroll > lastScroll && currentScroll > 100) {
                nav.classList.add('hide');
            } else {
                nav.classList.remove('hide');
            }
            lastScroll = currentScroll;
        });

        auth.onAuthStateChanged(user => {
            if (user) createWatermark(user.email);
            setupChapters();
            loadImages();
        });
    </script>
</body>
</html>
