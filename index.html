<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rawkuma | Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.05); 
            --accent: #8b5cf6; 
            --bg: #0f172a; 
            --card-bg: #1e293b;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Updated Top Scroller CSS --- */
        .top-scroller-container {
            padding: 15px 0 25px 0;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.5), transparent);
            overflow: hidden;
        }
        .top-scroll-wrapper {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 0 15px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .top-scroll-wrapper::-webkit-scrollbar { display: none; }
        
        .top-item {
            flex: 0 0 140px;
            text-decoration: none;
            color: white;
            position: relative;
            animation: fadeInUp 0.6s ease backwards;
        }
        .top-item img {
            width: 140px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid var(--glass);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .top-rating-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        .top-title {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-align: center;
        }

        * { 
            -webkit-user-select: none; -ms-user-select: none; user-select: none; 
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
        }
        input { -webkit-user-select: text; user-select: text; }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: white; 
            overflow-x: hidden; 
        }

        /* --- Animation Keyframes --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* --- VIP Badge Style --- */
        .vip-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
            font-size: 9px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            vertical-align: middle;
        }

        /* Ads Container Style */
        .ads-container-wrapper { 
            width: 100%; 
            background: #1e293b; 
            padding: 10px 0; 
            border-bottom: 2px solid var(--accent);
        }
        #ads-display-area {
            width: 95%;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Navigation & Sidebar UI */
        nav { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(15px); padding: 10px 15px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--glass); }
        .nav-top { display: flex; align-items: center; justify-content: space-between; width: 100%; height: 50px; }
        .menu-btn { font-size: 22px; cursor: pointer; transition: 0.3s; }
        .logo-text { font-size: 24px; font-weight: 800; color: var(--accent); letter-spacing: 2px; text-align: center; flex-grow: 1; text-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .site-logo { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); cursor: pointer; }

        /* --- New Refresh Icon Style --- */
        .refresh-btn { font-size: 20px; color: var(--accent); cursor: pointer; margin-right: 15px; transition: 0.3s; }
        .refresh-btn:active { transform: rotate(180deg); opacity: 0.7; }

        .sidebar { position: fixed; top: 0; left: -280px; width: 270px; height: 100%; background: #0f172a; z-index: 2000; transition: var(--transition); box-shadow: 10px 0 40px rgba(0,0,0,0.6); padding: 25px; box-sizing: border-box; border-right: 1px solid var(--glass); overflow-y: auto;}
        .sidebar.active { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; display: none; backdrop-filter: blur(6px); transition: 0.4s; }
        .overlay.active { display: block; }

        .search-container { width: 90%; max-width: 450px; position: relative; margin: 10px auto; }
        .search-container input { width: 100%; background: rgba(255,255,255,0.07); border: 1px solid var(--glass); border-radius: 25px; padding: 12px 15px 12px 45px; color: white; outline: none; transition: 0.3s; box-sizing: border-box;}
        .search-container input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
        .search-container i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--accent); }

        .container { padding: 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { border-left: 4px solid var(--accent); padding-left: 10px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        
        /* Advanced Filter Button Style */
        .adv-filter-btn { color: #f8fafc; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.3s; font-weight: 600; }
        .adv-filter-btn i { color: var(--accent); font-size: 16px; }
        .adv-filter-btn:active { transform: scale(0.95); opacity: 0.8; }

        .manga-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }

        .card { text-decoration: none; color: inherit; background: var(--card-bg); border-radius: 12px; overflow: hidden; position: relative; transition: var(--transition); border: 1px solid var(--glass); animation: fadeInUp 0.5s ease backwards; }
        .card:active { transform: scale(0.95); }
        .card img:not(.flag-badge) { width: 100%; height: 230px; object-fit: cover; display: block; }
        .flag-badge { position: absolute; top: 8px; left: 8px; width: 28px; border-radius: 3px; z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .card-info { padding: 12px; }
        .title { font-size: 13px; font-weight: 600; line-height: 1.4; height: 38px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- Home Star Rating Style --- */
        .home-star-box { display: flex; align-items: center; gap: 4px; margin-top: 8px; font-size: 14px; color: #64748b; }
        .home-star-box i { cursor: pointer; transition: 0.2s; }
        .home-star-box i.fas { color: #fbbf24; }
        .home-star-box i:active { transform: scale(1.3); }

        .menu-item { padding: 14px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #cbd5e1; transition: 0.3s; }
        .menu-item:active { background: rgba(139, 92, 246, 0.2); transform: scale(0.95); }

        footer { text-align: center; padding: 40px; font-size: 12px; color: #64748b; border-top: 1px solid var(--glass); margin-top: 20px; }

        /* Shimmer Loading */
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; }
        
        /* New Styles for Register Badge */
        .hot-badge {
            background: #ef4444; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: bold;
        }

        /* --- Inventory Modal Styles --- */
        #inventoryModal { display:none; position:fixed; z-index:4000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(10px); overflow-y:auto; padding:20px 10px; box-sizing: border-box; }
        .item-card { background: var(--card-bg); padding:15px; border-radius:12px; border:1px solid var(--glass); text-align:center; cursor:pointer; transition: 0.3s; }
        .item-card:active { transform: scale(0.95); }

        /* --- Profile Styles --- */
        #profileModal { display:none; position:fixed; z-index:4500; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.95); backdrop-filter:blur(15px); }
        .exp-bar-container { width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:10px; margin:15px 0; overflow:hidden; }
        .exp-bar-fill { height:100%; background: var(--accent); width:0%; transition: 1s ease-in-out; }
        .user-badge-label { font-size:10px; padding:3px 8px; border-radius:20px; background:var(--accent); color:white; font-weight:bold; text-transform:uppercase;}
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-size: 20px; color: var(--accent); margin:0; font-weight: 800;">RAWKUMA</h2>
            <i class="fas fa-times" style="cursor:pointer;" onclick="toggleMenu()"></i>
        </div>

        <div style="position: relative; margin-bottom: 15px;">
            <div class="profile-preview-card" onclick="openProfile()" style="padding:15px; background:var(--card-bg); border-radius:15px; border:1px solid var(--glass); cursor:pointer; display:flex; align-items:center; gap:12px;">
                <img id="sidebar-pfp" src="https://i.ibb.co/XfR4R4Jx/IMG-20260107-143629-039.jpg" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
                <div style="flex: 1;">
                    <div id="sidebar-name" style="font-weight:bold; font-size:14px;">Guest User</div>
                    <div id="sidebar-level" style="font-size:11px; color:var(--accent); font-weight:bold;">Level 1 Rookie</div>
                </div>
            </div>
            <a href="bookmarks.html" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #cbd5e1; font-size: 18px; text-decoration: none;">
                <i class="fas fa-bookmark"></i>
            </a>
        </div>

        <div class="coin-status-card" style="padding: 18px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05)); border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(251, 191, 36, 0.3);">
            <div style="font-size: 11px; color: #fbbf24; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">My Balance</div>
            <div style="display: flex; align-items: center; gap: 10px; font-size: 22px; color: #fbbf24; font-weight: 800; margin-top: 8px;">
                <i class="fas fa-coins"></i><span id="user-coins">0</span>
            </div>
            <div style="font-size: 9px; color: #64748b; margin-top: 8px; word-break: break-all;">ID: <span id="display-uid">Guest</span></div>
        </div>

        <div id="login-section">
            <div class="menu-item" onclick="openLoginModal()"><i class="fas fa-user-lock"></i> Login / Register</div>
        </div>

        <div id="user-info" style="display: none;">
            <div class="menu-item" onclick="openProfile()"><i class="fas fa-id-card"></i> View Profile</div>
            <a href="bookmarks.html" class="menu-item" style="text-decoration: none;">
                <i class="fas fa-bookmark" style="color: #60a5fa;"></i>
                <span>My Bookmarks</span>
            </a>
            <div class="menu-item" onclick="logout()" style="color: #ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>

        <div class="menu-list" style="margin-top: 15px; border-top: 1px solid var(--glass); padding-top: 15px;">
            <div class="menu-item" onclick="filterManga('all')"><i class="fas fa-home"></i> Home</div>
            
            <div class="menu-item" onclick="openInventory()" style="background: rgba(139, 92, 246, 0.1); border: 1px solid var(--glass);">
                <i class="fas fa-box-open" style="color: var(--accent);"></i>
                <span>My Inventory</span>
            </div>

            <div class="menu-item" onclick="filterManga('jp')"><i class="fas fa-book"></i> Manga</div>
            <div class="menu-item" onclick="filterManga('kr')"><i class="fas fa-scroll"></i> Manhwa</div>
            <div class="menu-item" onclick="filterManga('cn')"><i class="fas fa-pen-nib"></i> Manhua</div>
            <div class="menu-item" onclick="filterManga('18plus')"><i class="fas fa-heart"></i> 18+</div>
            <a href="DailyBonus.html" class="menu-item" style="text-decoration:none;">
                <i class="fas fa-gift" style="color: #fbbf24;"></i>
                <span>Daily Missions</span>
                <small class="hot-badge">NEW</small>
            </a>
        </div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div id="profileModal">
        <div style="padding:25px; position:relative;">
            <i class="fas fa-arrow-left" onclick="closeProfile()" style="font-size:20px; cursor:pointer; margin-bottom:20px;"></i>
            
            <div style="text-align:center; margin-top:20px;">
                <div style="position:relative; display:inline-block;">
                    <img id="profile-pfp" src="https://i.ibb.co/XfR4R4Jx/IMG-20260107-143629-039.jpg" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid var(--accent); box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);">
                    <div onclick="changePFP()" style="position:absolute; bottom:5px; right:5px; background:var(--accent); width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid #0f172a;">
                        <i class="fas fa-camera" style="font-size:14px;"></i>
                    </div>
                </div>
                
                <h2 id="profile-name" style="margin:15px 0 5px 0; font-size:22px;">Guest</h2>
                <span id="profile-badge-label" class="user-badge-label">Rookie</span>

                <div style="background:var(--card-bg); padding:20px; border-radius:20px; margin-top:30px; border:1px solid var(--glass);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:14px; font-weight:bold;">LEVEL <span id="profile-level">1</span></span>
                        <span id="profile-exp-text" style="font-size:12px; color:#94a3b8;">0/100 EXP</span>
                    </div>
                    <div class="exp-bar-container">
                        <div id="profile-exp-fill" class="exp-bar-fill"></div>
                    </div>
                    <p style="font-size:11px; color:#64748b; margin:0;">Level up to earn exclusive badges & gacha tickets!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="inventoryModal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent); margin:0; font-size: 20px;"><i class="fas fa-briefcase"></i> My Items</h2>
            <i class="fas fa-times" onclick="closeInventory()" style="font-size:24px; cursor:pointer;"></i>
        </div>
        
        <div id="weekly-pass-card" style="display:none; background: linear-gradient(135deg, #10b981, #064e3b); padding:20px; border-radius:15px; margin-bottom:20px;">
            <h3 style="margin:0; font-size:16px;">Weekly Pass Rewards</h3>
            <p id="claim-status" style="font-size:12px; opacity:0.8;">Daily claim is available!</p>
            <button id="claim-btn" onclick="claimWeeklyReward()" style="width:100%; background:white; color:#064e3b; border:none; padding:12px; border-radius:8px; font-weight:bold; margin-top:10px; cursor:pointer;">CLAIM COINS</button>
        </div>

        <div id="items-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;"></div>
    </div>

    <div id="itemDetailModal" style="display:none; position:fixed; z-index:5000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center;">
        <div id="detail-content" style="background:#1e293b; width:85%; max-width: 320px; padding:25px; border-radius:20px; border:1px solid var(--accent); text-align:center;"></div>
    </div>

    <div id="loginModal" style="display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px);">
        <div style="background: #1e293b; width: 85%; max-width: 320px; margin: 80px auto; padding: 25px; border-radius: 20px; border: 1px solid var(--accent); text-align: center;">
            <div id="login-form">
                <h3 style="color:var(--accent); margin-top:0;">Member Login</h3>
                <input type="email" id="email" placeholder="Email" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid var(--glass); background:#0f172a; color:white; box-sizing: border-box; outline: none;">
                <input type="password" id="password" placeholder="Password" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid var(--glass); background:#0f172a; color:white; box-sizing: border-box; outline: none;">
                <button onclick="handleLogin()" style="width:100%; background:var(--accent); color:white; border:none; padding:14px; border-radius:12px; margin-top:10px; font-weight:bold; cursor: pointer;">Login</button>
                <p style="font-size:12px; color:#64748b; margin-top:15px;">New user? <span onclick="toggleAuthMode()" style="color:var(--accent); cursor:pointer; font-weight:bold;">Register Here</span></p>
            </div>

            <div id="register-form" style="display:none;">
                <h3 style="color:var(--accent); margin-top:0;">Create Account</h3>
                <p style="font-size:11px; color:#fbbf24;">Register now & get 1 Free Gacha Ticket!</p>
                <input type="text" id="reg-name" placeholder="Full Name" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid var(--glass); background:#0f172a; color:white; box-sizing: border-box; outline: none;">
                <input type="email" id="reg-email" placeholder="Email Address" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid var(--glass); background:#0f172a; color:white; box-sizing: border-box; outline: none;">
                <input type="password" id="reg-pass" placeholder="Password (Min 6)" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid var(--glass); background:#0f172a; color:white; box-sizing: border-box; outline: none;">
                <button onclick="handleRegister()" style="width:100%; background:var(--accent); color:white; border:none; padding:14px; border-radius:12px; margin-top:10px; font-weight:bold; cursor: pointer;">Sign Up</button>
                <p style="font-size:12px; color:#64748b; margin-top:15px;">Have account? <span onclick="toggleAuthMode()" style="color:var(--accent); cursor:pointer; font-weight:bold;">Back to Login</span></p>
            </div>
            
            <button onclick="closeLoginModal()" style="background:none; border:none; color:#64748b; margin-top:10px; cursor: pointer;">Close</button>
        </div>
    </div>

    <nav>
        <div class="nav-top">
            <i class="fas fa-bars menu-btn" onclick="toggleMenu()"></i>
            <div class="logo-text">RAWKUMA</div>
            <i class="fas fa-sync-alt refresh-btn" onclick="location.reload()"></i>
            <img src="https://i.ibb.co/XfR4R4Jx/IMG-20260107-143629-039.jpg" id="nav-logo" class="site-logo" alt="Logo" onclick="location.reload()">
        </div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search stories...">
        </div>
    </nav>

    <div class="ads-container-wrapper">
        <div id="ads-display-area">
            <div style="height: 100px; border-radius: 12px;" class="skeleton"></div>
        </div>
    </div>

    <div class="top-scroller-container" id="top-rated-section" style="display: none;">
        <div class="container" style="padding-bottom: 10px;">
            <div class="section-header" style="margin-bottom: 15px;">
                <h3 class="section-title"><i class="fas fa-crown" style="color: #fbbf24;"></i> Top Rated</h3>
            </div>
        </div>
        <div class="top-scroll-wrapper" id="top-rated-list">
            </div>
    </div>

    <div class="container">
        <div class="section-header">
            <h3 class="section-title" id="page-title">Latest Updates</h3>
            <a href="AdvancedFilter.html" class="adv-filter-btn">
                <i class="fas fa-search-plus"></i> Advanced Filter
            </a>
        </div>
        <div class="manga-grid" id="main-list">
            <div class="card skeleton" style="height: 280px; border:none;"></div>
            <div class="card skeleton" style="height: 280px; border:none;"></div>
        </div>
    </div>

    <footer>&copy; 2026 Rawkuma Myanmar.</footer>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDkC9yCwozUjgTfFZ140qG112cU8GDCh44",
            authDomain: "rawkuma-8f1ba.firebaseapp.com",
            projectId: "rawkuma-8f1ba",
            storageBucket: "rawkuma-8f1ba.firebasestorage.app",
            messagingSenderId: "8257070386",
            appId: "1:8257070386:web:74d861728b8378d86f232b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- New Top Rated Function ---
        function loadTopRated() {
            const container = document.getElementById('top-rated-section');
            const list = document.getElementById('top-rated-list');
            
            db.collection("mangas").orderBy("rating", "desc").limit(8).onSnapshot(snap => {
                if (snap.empty) return container.style.display = 'none';
                container.style.display = 'block';
                list.innerHTML = "";
                let delay = 0;
                snap.forEach(doc => {
                    const m = doc.data();
                    const rating = m.rating ? m.rating.toFixed(1) : "0.0";
                    list.innerHTML += `
                        <a href="details.html?id=${doc.id}" class="top-item" style="animation-delay: ${delay}s">
                            <div class="top-rating-badge"><i class="fas fa-star"></i> ${rating}</div>
                            <img src="${m.cover}" onerror="this.src='https://via.placeholder.com/140x200'">
                            <div class="top-title">${m.title}</div>
                        </a>`;
                    delay += 0.1;
                });
            });
        }

        // --- Ad Function ---
        function displayAds() {
            const adContainer = document.getElementById('ads-display-area'); 
            db.collection("ads").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                adContainer.innerHTML = "";
                snapshot.forEach(doc => {
                    const ad = doc.data();
                    adContainer.innerHTML += `
                        <div class="ad-item" style="margin-bottom: 10px;">
                            <a href="${ad.targetUrl}" target="_blank">
                                <img src="${ad.imageUrl}" style="width:100%; border-radius:10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            </a>
                        </div>`;
                });
            });
        }

        // --- Auth Observer ---
        auth.onAuthStateChanged(user => {
            const infoBox = document.getElementById('user-info'), loginBtn = document.getElementById('login-section');
            if (user) {
                infoBox.style.display = 'block'; 
                loginBtn.style.display = 'none';
                
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        updateUIElements(user, userData);
                    }
                });
            } else {
                infoBox.style.display = 'none'; 
                loginBtn.style.display = 'block';
                resetUIElements();
            }
        });

        function updateUIElements(user, userData) {
            const level = userData.level || 1;
            const exp = userData.exp || 0;
            const nextLevelExp = 100;
            const badge = getBadge(level);
            const pfp = userData.pfp || "https://i.ibb.co/XfR4R4Jx/IMG-20260107-143629-039.jpg";

            // Sidebar & Nav Updates
            document.getElementById('sidebar-name').innerText = userData.name || "User";
            document.getElementById('sidebar-level').innerText = `Level ${level} ${badge}`;
            document.getElementById('sidebar-pfp').src = pfp;
            document.getElementById('nav-logo').src = pfp;
            document.getElementById('user-coins').innerText = (userData.coins || 0).toLocaleString();
            document.getElementById('display-uid').innerText = user.uid;

            // Profile Modal Updates
            document.getElementById('profile-name').innerText = userData.name || "User";
            document.getElementById('profile-level').innerText = level;
            document.getElementById('profile-exp-text').innerText = `${exp}/${nextLevelExp} EXP`;
            document.getElementById('profile-exp-fill').style.width = `${(exp / nextLevelExp) * 100}%`;
            document.getElementById('profile-badge-label').innerText = badge;
            document.getElementById('profile-pfp').src = pfp;
        }

        function getBadge(level) {
            if (level < 5) return "Rookie";
            if (level < 15) return "Pro Reader";
            if (level < 30) return "Elite";
            return "Legend";
        }

        function resetUIElements() {
            document.getElementById('user-coins').innerText = "0";
            document.getElementById('display-uid').innerText = "Guest";
            document.getElementById('sidebar-name').innerText = "Guest User";
            document.getElementById('sidebar-level').innerText = "Level 1 Rookie";
        }

        // --- Profile Actions ---
        function openProfile() {
            if(!auth.currentUser) return openLoginModal();
            toggleMenu();
            document.getElementById('profileModal').style.display = 'block';
        }
        function closeProfile() { document.getElementById('profileModal').style.display = 'none'; }

        // --- Updated PFP Change Logic ---
        async function changePFP() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 800 * 1024) { 
                    alert("ပုံအရွယ်အစား 800KB ထက်မကျော်ရပါ။ ပုံကို compress အရင်လုပ်ပေးပါ။");
                    return;
                }

                const reader = new FileReader();
                reader.onloadstart = () => {
                    document.getElementById('profile-name').innerText = "Uploading...";
                };

                reader.onloadend = async () => {
                    const base64String = reader.result;
                    try {
                        const user = auth.currentUser;
                        if (!user) return alert("Login အရင်ဝင်ပေးပါ။");
                        await db.collection("users").doc(user.uid).update({ pfp: base64String });
                        alert("Profile Picture Updated Successfully!");
                    } catch (error) {
                        console.error(error);
                        alert("Error: " + error.message);
                    }
                };
                reader.readAsDataURL(file);
            };
            fileInput.click();
        }

        // --- Auth Functions ---
        function toggleAuthMode() {
            const lForm = document.getElementById('login-form');
            const rForm = document.getElementById('register-form');
            if (lForm.style.display === 'none') {
                lForm.style.display = 'block'; rForm.style.display = 'none';
            } else {
                lForm.style.display = 'none'; rForm.style.display = 'block';
            }
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            if(!name || !email || pass.length < 6) return alert("Please fill all fields correctly!");

            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(res.user.uid).set({
                    name: name,
                    email: email,
                    role: "user",
                    coins: 0,
                    tickets: 1, 
                    level: 1,
                    exp: 0,
                    pfp: "https://i.ibb.co/XfR4R4Jx/IMG-20260107-143629-039.jpg",
                    membership: "Free",
                    hasWeeklyPass: false,
                    lastWeeklyClaim: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Account created successfully! Level 1 Unlocked.");
                closeLoginModal();
            } catch (err) { alert(err.message); }
        }

        function handleLogin() {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p).then(() => { closeLoginModal(); }).catch(err => alert(err.message));
        }

        // --- Inventory & Weekly Pass System ---
        async function openInventory() {
            const user = auth.currentUser;
            if(!user) return openLoginModal();
            
            toggleMenu();
            document.getElementById('inventoryModal').style.display = 'block';
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '<div class="skeleton" style="height:100px; grid-column: span 2;"></div>';

            const doc = await db.collection("users").doc(user.uid).get();
            const data = doc.data();
            grid.innerHTML = "";

            if(data.hasWeeklyPass && data.weeklyPassExpiry && data.weeklyPassExpiry.toDate() > new Date()) {
                document.getElementById('weekly-pass-card').style.display = 'block';
                updateClaimUI(data);
                addItemToGrid("Weekly Pass", "fa-calendar-check", "#10b981", data.weeklyPassPurchaseDate, data.weeklyPassExpiry);
            } else {
                document.getElementById('weekly-pass-card').style.display = 'none';
            }

            if(data.membership === "VIP") {
                addItemToGrid("VIP Membership", "fa-crown", "#fbbf24", data.vipStartDate, data.vipExpiry);
            }

            if(data.tickets > 0) {
                addItemToGrid("Gacha Tickets", "fa-ticket-alt", "#ef4444", null, null, data.tickets);
            }
            
            addItemToGrid("Wallet Coins", "fa-coins", "#fbbf24", null, null, data.coins);
        }

        function updateClaimUI(data) {
            const btn = document.getElementById('claim-btn');
            const status = document.getElementById('claim-status');
            const today = new Date().toDateString();
            const lastClaim = data.lastWeeklyClaim ? data.lastWeeklyClaim.toDate().toDateString() : "";

            if (lastClaim === today) {
                btn.disabled = true;
                btn.innerText = "ALREADY CLAIMED TODAY";
                btn.style.opacity = "0.5";
                status.innerText = "Next reward available tomorrow!";
            } else {
                btn.disabled = false;
                const isBonus = !data.lastWeeklyClaim;
                btn.innerText = isBonus ? "CLAIM 800 COINS (Bonus)" : "CLAIM 500 COINS";
                btn.style.opacity = "1";
                status.innerText = "Daily reward is ready!";
            }
        }

        async function claimWeeklyReward() {
            const user = auth.currentUser;
            const btn = document.getElementById('claim-btn');
            btn.disabled = true;
            try {
                const userRef = db.collection("users").doc(user.uid);
                const doc = await userRef.get();
                const data = doc.data();
                const today = new Date().toDateString();
                const lastClaim = data.lastWeeklyClaim ? data.lastWeeklyClaim.toDate().toDateString() : "";

                if (lastClaim === today) throw new Error("Already claimed today!");
                const reward = !data.lastWeeklyClaim ? 800 : 500;
                let newExp = (data.exp || 0) + 10;
                let newLevel = data.level || 1;
                let bonusTicket = 0;

                if (newExp >= 100) { newLevel++; newExp = 0; bonusTicket = 1; alert("LEVEL UP! Level " + newLevel + " Reached."); }

                await userRef.update({
                    coins: firebase.firestore.FieldValue.increment(reward),
                    exp: newExp,
                    level: newLevel,
                    tickets: firebase.firestore.FieldValue.increment(bonusTicket),
                    lastWeeklyClaim: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`Success! You claimed ${reward} coins.`);
                openInventory();
            } catch(e) { alert(e.message); btn.disabled = false; }
        }

        function addItemToGrid(name, icon, color, start, end, amount = null) {
            const grid = document.getElementById('items-grid');
            const div = document.createElement('div');
            div.className = 'item-card';
            div.style.borderColor = color + "44";
            div.onclick = () => showItemDetail(name, start, end);
            div.innerHTML = `
                <i class="fas ${icon}" style="font-size:28px; color:${color}; margin-bottom:10px;"></i>
                <div style="font-size:13px; font-weight:bold;">${name}</div>
                <div style="font-size:11px; color:#94a3b8; margin-top:4px;">${amount !== null ? amount.toLocaleString() : 'View Details'}</div>
            `;
            grid.appendChild(div);
        }

        function showItemDetail(name, start, end) {
            const modal = document.getElementById('itemDetailModal');
            const content = document.getElementById('detail-content');
            modal.style.display = 'flex';
            const startStr = start ? start.toDate().toLocaleDateString() : "N/A";
            const endStr = end ? end.toDate().toLocaleDateString() : "Permanent Item";
            content.innerHTML = `
                <h3 style="color:var(--accent); margin-top:0;">${name}</h3>
                <div style="text-align:left; margin:20px 0; font-size:13px;">
                    <p style="color:#94a3b8;">Status: <span style="color:#10b981;">Active</span></p>
                    <p style="color:#94a3b8;">Started: <span style="color:white;">${startStr}</span></p>
                    <p style="color:#94a3b8;">Expired: <span style="color:#ef4444;">${endStr}</span></p>
                </div>
                <button onclick="document.getElementById('itemDetailModal').style.display='none'" style="width:100%; background:var(--accent); color:white; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">Close</button>
            `;
        }

        function closeInventory() { document.getElementById('inventoryModal').style.display = 'none'; }

        const flags = { "jp": "https://flagcdn.com/w40/jp.png", "kr": "https://flagcdn.com/w40/kr.png", "cn": "https://flagcdn.com/w40/cn.png" };
        
        // --- Added Star System Implementation ---
        async function toggleHomeStar(event, mangaId) {
            event.preventDefault(); // Link မပွင့်သွားအောင်တားတာ
            event.stopPropagation(); // Card Click event မဖြစ်အောင်တားတာ

            if (!auth.currentUser) return openLoginModal();

            const mangaRef = db.collection("mangas").doc(mangaId);
            const userRef = db.collection("users").doc(auth.currentUser.uid);
            const userRatingRef = mangaRef.collection("ratings").doc(auth.currentUser.uid);

            try {
                const ratingDoc = await userRatingRef.get();
                
                await db.runTransaction(async (transaction) => {
                    const mDoc = await transaction.get(mangaRef);
                    let currentCount = mDoc.data().ratingCount || 0;
                    let currentAvg = mDoc.data().rating || 0;
                    
                    if (ratingDoc.exists) {
                        // Rating ဖြုတ်မယ် (Decrease)
                        let newCount = currentCount - 1;
                        let newAvg = newCount > 0 ? (currentAvg * currentCount - 5) / newCount : 0;
                        transaction.update(mangaRef, { rating: newAvg, ratingCount: newCount });
                        transaction.delete(userRatingRef);
                    } else {
                        // Rating အသစ်ပေးမယ် (Increase)
                        let newCount = currentCount + 1;
                        let newAvg = (currentAvg * currentCount + 5) / newCount;
                        transaction.update(mangaRef, { rating: newAvg, ratingCount: newCount });
                        transaction.set(userRatingRef, { rating: 5, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                });
            } catch (e) {
                console.error("Star Error:", e);
            }
        }

        function loadMangasFromDB(filterType = 'all', searchTerm = '') {
            const grid = document.getElementById('main-list');
            let query = db.collection("mangas").orderBy("updatedAt", "desc");
            if (filterType !== 'all') query = db.collection("mangas").where("type", "==", filterType).orderBy("updatedAt", "desc");

            query.onSnapshot((querySnapshot) => {
                grid.innerHTML = "";
                let delay = 0;
                querySnapshot.forEach(async (doc) => {
                    const manga = doc.data();
                    if (searchTerm && !manga.title.toLowerCase().includes(searchTerm.toLowerCase())) return;
                    
                    const mangaId = doc.id;
                    const card = document.createElement('div'); // <a> ကို <div> ပြောင်းလိုက်တယ် Star နှိပ်ရလွယ်အောင်
                    card.className = 'card';
                    card.style.animationDelay = `${delay}s`; 
                    
                    // User ပေးထားပြီးသားလား check တာ
                    let starClass = 'far'; // default empty star
                    if (auth.currentUser) {
                        const checkRating = await db.collection("mangas").doc(mangaId).collection("ratings").doc(auth.currentUser.uid).get();
                        if (checkRating.exists) starClass = 'fas'; // filled star
                    }

                    card.innerHTML = `
                        <a href="details.html?id=${mangaId}" style="text-decoration:none; color:inherit;">
                            <img class="flag-badge" src="${flags[manga.type] || flags['jp']}">
                            <img src="${manga.cover}" loading="lazy" onerror="this.src='https://via.placeholder.com/230x300?text=No+Cover'">
                        </a>
                        <div class="card-info">
                            <a href="details.html?id=${mangaId}" style="text-decoration:none; color:inherit;">
                                <div class="title">${manga.title}</div>
                            </a>
                            <div class="home-star-box">
                                <i class="${starClass} fa-star" onclick="toggleHomeStar(event, '${mangaId}')"></i>
                                <span>${manga.rating ? manga.rating.toFixed(1) : "0.0"}</span>
                            </div>
                        </div>`;
                    grid.appendChild(card);
                    delay += 0.05;
                });
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => loadMangasFromDB('all', e.target.value));
        function filterManga(type) { loadMangasFromDB(type); toggleMenu(); }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
        function openLoginModal() { 
            document.getElementById('loginModal').style.display = 'block'; 
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }
        function closeLoginModal() { document.getElementById('loginModal').style.display = 'none'; }
        function logout() { auth.signOut(); }

        loadMangasFromDB();
        displayAds();
        loadTopRated();
    </script>
</body>
</html>

