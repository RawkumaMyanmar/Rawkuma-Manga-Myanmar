<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Advanced Filter | Rawkuma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --accent: #8b5cf6; --bg: #0f172a; --card-bg: #1e293b; 
            --glass: rgba(255, 255, 255, 0.05); --transition: all 0.3s ease;
        }

        /* --- Global Protection --- */
        * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); 
            color: white; margin: 0; min-height: 100vh;
        }

        nav {
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            padding: 15px; position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--glass);
        }

        .back-btn { color: white; text-decoration: none; font-size: 20px; }

        /* Filter UI */
        .filter-container { padding: 20px; animation: fadeIn 0.5s ease; }
        
        .filter-box {
            background: var(--card-bg); padding: 20px; border-radius: 20px;
            border: 1px solid var(--glass); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        select, button {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--glass);
            background: #111827; color: white; margin-bottom: 15px; outline: none;
        }

        .genre-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-height: 350px; overflow-y: auto; padding: 10px;
            background: rgba(0,0,0,0.2); border-radius: 12px;
        }

        .genre-item {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--glass); border-radius: 8px; cursor: pointer;
            transition: var(--transition); font-size: 13px;
        }

        .genre-item:has(input:checked) { background: var(--accent); color: white; }
        .genre-item input { display: none; }

        .apply-btn {
            background: var(--accent); color: white; border: none; font-weight: 800;
            cursor: pointer; margin-top: 20px; transition: 0.3s;
        }
        .apply-btn:active { transform: scale(0.95); }

        /* Results Grid */
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px; padding: 20px;
        }

        .manga-card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden;
            text-decoration: none; color: white; transition: 0.3s;
            animation: cardIn 0.5s ease backwards;
        }
        .manga-card img { width: 100%; height: 160px; object-fit: cover; pointer-events: none; }
        .manga-card .title { padding: 8px; font-size: 12px; font-weight: 600; text-align: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes cardIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body oncontextmenu="return false;">

    <nav>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <div style="font-weight: 800;">ADVANCED FILTER</div>
    </nav>

    <div class="filter-container">
        <div class="filter-box">
            <label style="font-size: 12px; color: #94a3b8;">STORY TYPE</label>
            <select id="filter-type">
                <option value="all">All Types</option>
                <option value="jp">Manga (Japan)</option>
                <option value="kr">Manhwa (Korea)</option>
                <option value="cn">Manhua (China)</option>
                <option value="18plus">18+ (Adult Content)</option>
            </select>

            <label style="font-size: 12px; color: #94a3b8;">SELECT GENRES</label>
            <div id="genre-checkboxes" class="genre-grid"></div>

            <button class="apply-btn" onclick="applyAdvancedFilter()">APPLY FILTER</button>
            <center><span onclick="resetFilter()" style="font-size: 12px; color: #64748b; cursor: pointer;">Reset All</span></center>
        </div>
    </div>

    <div id="results-count" style="padding: 0 20px; font-size: 14px; color: var(--accent);"></div>
    <div class="results-grid" id="main-list"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDkC9yCwozUjgTfFZ140qG112cU8GDCh44",
            projectId: "rawkuma-8f1ba",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Updated Detailed Genre List ---
        const genreList = [
            "Action", "Adult", "Adventure", "Comedy", "Cooking", "Crime", 
            "Cultivation", "Drama", "Ecchi", "Fantasy", "Gender Bender", 
            "Harem", "Historical", "Horror", "Isekai", "Josei", "Magic", 
            "Martial Arts", "Mature", "Mecha", "Medical", "Mystery", 
            "Psychological", "Reincarnation", "Romance", "School Life", 
            "Sci-Fi", "Seinen", "Shoujo", "Shounen", "Slice of Life", 
            "Sports", "Supernatural", "Thriller", "Tragedy", "Webtoon"
        ];

        function displayGenreCheckboxes() {
            const container = document.getElementById('genre-checkboxes');
            container.innerHTML = genreList.map(g => `
                <label class="genre-item">
                    <input type="checkbox" class="genre-check" value="${g}" onchange="this.parentElement.classList.toggle('active')">
                    <i class="fas fa-tag"></i> ${g}
                </label>
            `).join('');
        }

        async function applyAdvancedFilter() {
            const type = document.getElementById('filter-type').value;
            const genres = Array.from(document.querySelectorAll('.genre-check:checked')).map(cb => cb.value);
            const grid = document.getElementById('main-list');
            
            grid.innerHTML = "<div style='grid-column: 1/-1; text-align:center; padding: 40px;'><i class='fas fa-spinner fa-spin'></i> Filtering...</div>";

            let query = db.collection("mangas");
            if (type !== 'all') query = query.where("type", "==", type);

            const snapshot = await query.orderBy("updatedAt", "desc").get();
            grid.innerHTML = "";
            let count = 0;

            snapshot.forEach(doc => {
                const manga = doc.data();
                if (genres.length > 0) {
                    const mangaGenres = manga.genres || [];
                    const hasAll = genres.every(g => mangaGenres.includes(g));
                    if (!hasAll) return;
                }
                
                count++;
                const card = document.createElement('a');
                card.href = `details.html?id=${doc.id}`;
                card.className = 'manga-card';
                card.style.animationDelay = `${count * 0.05}s`;
                card.innerHTML = `
                    <img src="${manga.cover}" onerror="this.src='https://via.placeholder.com/110x160'">
                    <div class="title">${manga.title}</div>
                `;
                grid.appendChild(card);
            });

            document.getElementById('results-count').innerText = `Found ${count} titles`;
            if (count === 0) grid.innerHTML = "<div style='grid-column: 1/-1; text-align:center; padding: 40px; color: #64748b;'>No results found for this combination.</div>";
        }

        function resetFilter() {
            document.getElementById('filter-type').value = 'all';
            document.querySelectorAll('.genre-check').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('active');
            });
            document.getElementById('main-list').innerHTML = "";
            document.getElementById('results-count').innerText = "";
        }

        displayGenreCheckboxes();
    </script>
</body>
</html>
